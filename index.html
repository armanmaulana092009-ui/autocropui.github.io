<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pas Foto Pro - Unit-01 Interface</title>
    <!-- Library Face API untuk deteksi wajah AI -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <!-- Library JSZip untuk fitur download massal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Tailwind CSS untuk styling modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;600;700&family=Share+Tech+Mono&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --eva-purple: #2d1b4d;
            --eva-purple-bright: #7a1fa2;
            --eva-neon-green: #44ff00;
            --eva-neon-green-glow: rgba(68, 255, 0, 0.4);
            --eva-red: #ff0033;
            --bg-dark: #07050a;
            --panel-bg: rgba(26, 15, 46, 0.9);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark);
            color: var(--eva-neon-green);
            background-image: 
                linear-gradient(rgba(122, 31, 162, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(122, 31, 162, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .magi-title {
            font-family: 'Teko', sans-serif;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            line-height: 0.8;
            border-left: 12px solid var(--eva-neon-green);
            padding-left: 15px;
            color: #ffffff;
            text-shadow: 0 0 10px var(--eva-neon-green-glow);
        }

        .mono-font {
            font-family: 'Share Tech Mono', monospace;
        }

        .eva-panel {
            background: var(--panel-bg);
            border: 1px solid var(--eva-purple-bright);
            box-shadow: inset 0 0 20px rgba(122, 31, 162, 0.3), 0 0 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .eva-panel::before {
            content: "";
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 4px;
            background: repeating-linear-gradient(90deg, var(--eva-neon-green), var(--eva-neon-green) 10px, transparent 10px, transparent 20px);
        }

        .drop-zone {
            transition: all 0.3s ease;
            background: rgba(122, 31, 162, 0.1);
            border: 1px dashed var(--eva-purple-bright);
        }
        
        .drop-zone.drag-over {
            background-color: rgba(68, 255, 0, 0.1);
            border-color: var(--eva-neon-green);
            box-shadow: 0 0 20px var(--eva-neon-green-glow);
        }

        .scroll-container {
            max-height: 75vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--eva-purple-bright) transparent;
        }

        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--eva-purple-bright); border-radius: 10px; }

        canvas {
            border: 2px solid var(--eva-neon-green);
            box-shadow: 0 0 10px var(--eva-neon-green-glow);
            width: 100%;
            height: auto;
            display: block;
        }

        .status-badge {
            position: absolute;
            top: 0; left: 0;
            padding: 2px 8px;
            font-family: 'Teko', sans-serif;
            font-size: 14px;
            font-weight: 700;
            z-index: 20;
            text-transform: uppercase;
        }

        .status-success { background: var(--eva-neon-green); color: black; }
        .status-fail { background: var(--eva-red); color: white; animation: blink 0.5s infinite; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .eva-button {
            background: var(--eva-purple-bright);
            color: white;
            font-family: 'Teko', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s ease;
            clip-path: polygon(0 0, 95% 0, 100% 30%, 100% 100%, 5% 100%, 0 70%);
            border: 1px solid var(--eva-neon-green);
        }

        .eva-button:hover:not(:disabled) {
            background: var(--eva-neon-green);
            color: black;
            transform: translateY(-2px);
            box-shadow: 0 0 15px var(--eva-neon-green-glow);
        }

        .eva-button:disabled {
            background: #1a0f2e;
            color: #4b2c6d;
            border-color: #4b2c6d;
            cursor: not-allowed;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid var(--eva-purple-bright);
            border-bottom-color: var(--eva-neon-green);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hazard-bar {
            background: repeating-linear-gradient(45deg, var(--eva-neon-green), var(--eva-neon-green) 15px, var(--eva-purple) 15px, var(--eva-purple) 30px);
            height: 12px;
            width: 100%;
            border-bottom: 1px solid var(--eva-neon-green);
        }

        /* Khusus untuk area Gagal */
        .fail-scroll {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Hover actions for individual items */
        .item-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 30;
        }

        .preview-container:hover .item-actions {
            opacity: 1;
        }

        .action-btn {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn-dl { background: var(--eva-neon-green); color: black; }
        .btn-rm { background: var(--eva-red); color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-green-500 selection:text-black">

<div class="hazard-bar"></div>

<div class="max-w-7xl mx-auto px-4 py-8 flex-grow w-full">
    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-end mb-8 border-b-2 border-purple-800 pb-4 gap-4">
        <div class="text-left">
            <h1 class="magi-title text-4xl md:text-6xl flex flex-col">
                <span class="text-xs tracking-[0.8em] text-green-400 mb-1 opacity-80">BIOMETRIC_SYSTEM_v4.0</span>
                <span>UNIT <span class="text-purple-400">01</span>: AUTO CROP FOTO 3x4 ULTIMATE</span>
            </h1>
            <p class="mono-font text-[10px] mt-1 tracking-widest text-green-400">
                NEURAL SYNC INTERFACE // SYNC RATE: 400% // PRODUCTION_MODE_ON
            </p>
        </div>
        <div class="text-right mono-font text-[9px] leading-tight opacity-80 text-purple-400 hidden md:block">
            <div>PILOT: SHINJI IKARI [DERRY]</div>
            <div>STATUS: LCL_FLOW_STABLE</div>
            <div>RESTRICTED ACCESS: NERV HQ AREA-01</div>
        </div>
    </header>

    <!-- Kontrol Utama -->
    <div class="eva-panel rounded-sm p-4 lg:p-6 mb-8">
        <div id="loadingOverlay" class="flex flex-col items-center justify-center py-6">
            <div class="loader mb-4"></div>
            <span id="status" class="mono-font text-xs tracking-[0.3em] animate-pulse text-green-400">CONNECTING TO ENTRY PLUG...</span>
        </div>

        <div id="mainUI" class="hidden">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Dropzone Section -->
                <div class="flex-grow">
                    <div id="dropZone" class="drop-zone group p-6 lg:p-10 text-center cursor-pointer relative rounded-lg">
                        <input type="file" id="upload" accept="image/*" multiple class="hidden">
                        <div class="flex flex-col items-center">
                            <h3 class="mono-font text-lg font-bold mb-1 text-white uppercase">DATA INPUT</h3>
                            <p class="mono-font text-[9px] text-purple-300">UPLOAD SAMPLES FOR BIOMETRIC CROP ANALYSIS</p>
                        </div>
                    </div>
                </div>

                <!-- Control Center Section -->
                <div class="lg:w-72 flex flex-col justify-between gap-4">
                    <div class="grid grid-cols-3 lg:grid-cols-1 gap-2 mono-font">
                        <div class="bg-purple-900/40 border border-purple-500/40 p-2 flex flex-col justify-center items-center text-purple-200">
                            <span class="text-[8px] uppercase">Samples</span>
                            <span id="totalCount" class="text-xl font-bold leading-none">0</span>
                        </div>
                        <div class="bg-green-950/20 border border-green-500/40 p-2 flex flex-col justify-center items-center text-green-400">
                            <span class="text-[8px] uppercase">Sync_OK</span>
                            <span id="successCount" class="text-xl font-bold leading-none">0</span>
                        </div>
                        <div class="bg-red-950/20 border border-red-500/40 p-2 flex flex-col justify-center items-center text-red-500">
                            <span class="text-[8px] uppercase">Error</span>
                            <span id="failCount" class="text-xl font-bold leading-none">0</span>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <button id="downloadZip" disabled class="eva-button w-full py-3 text-lg">
                            EXPORT_ZIP
                        </button>
                        <button id="btnClear" class="w-full py-1 mono-font text-[9px] border border-purple-700 hover:bg-red-900/20 transition-colors text-purple-400 uppercase">
                            Eject Plug
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tampilan Dashboard Hasil -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
        <!-- Area Hasil Berhasil -->
        <main class="lg:col-span-8 space-y-4">
            <div class="bg-purple-700 text-white px-3 py-1 text-[9px] font-black tracking-widest uppercase border-l-4 border-green-400 flex justify-between items-center">
                <span>Verified Output: Normalization List</span>
                <span class="opacity-50 mono-font text-[8px]">CASPER_READY</span>
            </div>
            
            <div class="scroll-container bg-purple-950/20 border border-purple-900/40 p-4 rounded-sm">
                <div id="previewSuccess" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <div id="emptyState" class="col-span-full flex flex-col items-center justify-center py-20 opacity-30 mono-font text-purple-400">
                        <p class="text-[10px] tracking-[0.2em]">AWAITING NEURAL LINK...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Area Hasil Gagal -->
        <aside class="lg:col-span-4 space-y-4">
            <div class="bg-red-700 text-white px-3 py-1 text-[9px] font-black tracking-widest uppercase border-l-4 border-black flex justify-between">
                <span>Pattern Blue: Rejection Log</span>
                <span class="opacity-50 mono-font text-[8px]">Balthasar_Report</span>
            </div>

            <div class="fail-scroll bg-red-950/10 border border-red-900/30 p-3 rounded-sm scroll-container">
                <div id="previewFail" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-2 gap-3">
                    <!-- Failed items go here -->
                </div>
                <div id="noFailState" class="py-10 flex flex-col items-center justify-center opacity-20 mono-font text-[8px] text-red-400">
                    <p>NO_PATTERN_BLUE_DETECTED</p>
                </div>
            </div>

            <div class="eva-panel p-3">
                <h4 class="mono-font text-[10px] font-bold mb-2 border-b border-purple-800 pb-1 text-green-400 uppercase tracking-wider">NERV System Logs</h4>
                <div class="mono-font text-[8px] text-purple-300 space-y-1">
                    <p>> AUTO_ALIGNMENT: ACTIVE</p>
                    <p>> FACE_DETECT_THRES: 0.20</p>
                    <p>> LCL_DENSITY: NOMINAL</p>
                </div>
            </div>
        </aside>
    </div>
</div>

<footer class="py-8 border-t border-purple-900/30 mt-8">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center opacity-40 mono-font text-[7px] tracking-[0.5em] text-purple-400">
        <span>GOD'S IN HIS HEAVEN. ALL'S RIGHT WITH THE WORLD.</span>
        <span>EV-01 SYSTEM READY</span>
    </div>
</footer>

<script>
    const upload = document.getElementById('upload');
    const dropZone = document.getElementById('dropZone');
    const previewSuccess = document.getElementById('previewSuccess');
    const previewFail = document.getElementById('previewFail');
    const statusText = document.getElementById('status');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const mainUI = document.getElementById('mainUI');
    const btnZip = document.getElementById('downloadZip');
    const btnClear = document.getElementById('btnClear');
    const emptyState = document.getElementById('emptyState');
    const noFailState = document.getElementById('noFailState');
    
    const totalCountDisp = document.getElementById('totalCount');
    const successCountDisp = document.getElementById('successCount');
    const failCountDisp = document.getElementById('failCount');
    
    let croppedImages = []; // Stores objects: { id, name, data }
    let successCount = 0;
    let failCount = 0;
    let totalInQueue = 0;

    async function initAI() {
        try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            loadingOverlay.classList.add('hidden');
            mainUI.classList.remove('hidden');
        } catch (err) {
            statusText.innerText = "SYSTEM ERROR: SYNC FAILED";
        }
    }

    dropZone.onclick = () => upload.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
    dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    };
    upload.onchange = (e) => handleFiles(e.target.files);

    btnClear.onclick = () => {
        previewSuccess.innerHTML = '';
        previewSuccess.appendChild(emptyState);
        previewFail.innerHTML = '';
        noFailState.style.display = 'flex';
        croppedImages = [];
        successCount = 0;
        failCount = 0;
        totalInQueue = 0;
        updateStats();
        btnZip.disabled = true;
        upload.value = '';
        if (emptyState) emptyState.style.display = 'flex';
    };

    async function handleFiles(files) {
        if (!files || files.length === 0) return;
        if (emptyState) emptyState.style.display = 'none';
        loadingOverlay.classList.remove('hidden');
        
        for (let file of files) {
            if (!file.type.startsWith('image/')) continue;
            totalInQueue++;
            statusText.innerText = `SCANNING SAMPLE ${totalInQueue}...`;
            
            const fileId = crypto.randomUUID();
            const container = document.createElement('div');
            container.id = `item-${fileId}`;
            container.className = "preview-container flex flex-col items-center group relative w-full mb-2";

            try {
                const img = await faceapi.bufferToImage(file);
                let detections = await faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.2 }));

                if (detections.length === 0) {
                    detections = await faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.15 }));
                }

                if (detections.length > 0) {
                    const face = detections.sort((a, b) => b.box.width - a.box.width)[0].box;
                    const canvas = createAlignedCrop(img, face);
                    const base64 = canvas.toDataURL('image/jpeg', 0.95);
                    const baseName = file.name.replace(/\.[^/.]+$/, "");
                    const finalFileName = `${baseName}.jpg`;

                    container.innerHTML = `
                        <div class="relative w-full overflow-hidden border border-green-500/50 rounded-sm">
                            <span class="status-badge status-success">SYNC_OK</span>
                            <div class="item-actions">
                                <button class="action-btn btn-dl" onclick="downloadSingle('${base64}', '${finalFileName}')">DL</button>
                                <button class="action-btn btn-rm" onclick="removeItem('${fileId}', 'success')">X</button>
                            </div>
                        </div>
                    `;
                    container.querySelector('.relative').prepend(canvas);
                    
                    successCount++;
                    croppedImages.push({ 
                        id: fileId,
                        name: finalFileName, 
                        data: base64 
                    });
                    previewSuccess.appendChild(container);
                } else {
                    throw new Error("Pattern Blue");
                }
            } catch (err) {
                noFailState.style.display = 'none';
                container.innerHTML = `
                    <div class="w-full aspect-[3/4] bg-red-950/20 border border-red-500/50 flex flex-col items-center justify-center relative rounded-sm overflow-hidden">
                        <span class="status-badge status-fail">ERR</span>
                        <div class="item-actions">
                            <button class="action-btn btn-rm" onclick="removeItem('${fileId}', 'fail')">X</button>
                        </div>
                        <div class="mono-font text-[7px] text-red-500 font-bold px-1 text-center leading-tight z-10">BIOMETRIC MISMATCH</div>
                        <div class="absolute inset-0 opacity-10 pointer-events-none bg-[url('https://media.giphy.com/media/oEI9uWU0WMrQmpxBYy/giphy.gif')] bg-cover"></div>
                    </div>
                `;
                failCount++;
                previewFail.appendChild(container);
            }

            const label = document.createElement('span');
            label.className = "mono-font text-[7px] text-purple-400 mt-1 truncate w-full text-center px-1 opacity-70";
            label.innerText = file.name;
            container.appendChild(label);
            
            updateStats();
        }

        loadingOverlay.classList.add('hidden');
        btnZip.disabled = croppedImages.length === 0;
    }

    function downloadSingle(data, filename) {
        const link = document.createElement('a');
        link.href = data;
        link.download = filename;
        link.click();
    }

    function removeItem(id, type) {
        const el = document.getElementById(`item-${id}`);
        if (el) el.remove();

        if (type === 'success') {
            croppedImages = croppedImages.filter(img => img.id !== id);
            successCount--;
            if (previewSuccess.children.length === 1 && previewSuccess.contains(emptyState)) {
                // Should not happen if item was there
            } else if (previewSuccess.querySelectorAll('.preview-container').length === 0) {
                emptyState.style.display = 'flex';
                previewSuccess.appendChild(emptyState);
            }
        } else {
            failCount--;
            if (previewFail.querySelectorAll('.preview-container').length === 0) {
                noFailState.style.display = 'flex';
            }
        }
        
        updateStats();
        btnZip.disabled = croppedImages.length === 0;
    }

    function updateStats() {
        totalCountDisp.innerText = successCount + failCount;
        successCountDisp.innerText = successCount;
        failCountDisp.innerText = failCount;
    }

    function createAlignedCrop(img, face) {
        const canvas = document.createElement('canvas');
        const outW = 600; 
        const outH = 800; 
        canvas.width = outW;
        canvas.height = outH;
        const ctx = canvas.getContext('2d');

        const targetFaceHeightRatio = 0.40; 
        const cropHeight = face.height / targetFaceHeightRatio;
        const cropWidth = cropHeight * (outW / outH);

        const centerX = face.x + (face.width / 2);
        const centerY = face.y + (face.height / 2);

        let srcX = centerX - (cropWidth / 2);
        let srcY = centerY - (cropHeight / 2); 

        ctx.fillStyle = "#000000"; 
        ctx.fillRect(0, 0, outW, outH);
        
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        ctx.drawImage(img, srcX, srcY, cropWidth, cropHeight, 0, 0, outW, outH);
        
        ctx.fillStyle = "rgba(68, 255, 0, 0.03)";
        ctx.fillRect(0, 0, outW, outH);

        return canvas;
    }

    btnZip.onclick = async () => {
        if (croppedImages.length === 0) return;
        const zip = new JSZip();
        const nameMap = new Map();

        croppedImages.forEach((img) => {
            let finalName = img.name;
            if (nameMap.has(finalName)) {
                const count = nameMap.get(finalName) + 1;
                nameMap.set(finalName, count);
                finalName = finalName.replace(".jpg", `_${count}.jpg`);
            } else {
                nameMap.set(finalName, 0);
            }
            const base64Data = img.data.split(',')[1];
            zip.file(finalName, base64Data, {base64: true});
        });

        const content = await zip.generateAsync({type: "blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `EVA_UNIT_01_EXPORT.zip`;
        link.click();
    };

    window.onload = initAI;
</script>

</body>
</html>